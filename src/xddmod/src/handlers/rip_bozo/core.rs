use async_recursion::async_recursion;
use lazy_static::lazy_static;
use regex::Regex;
use sqlx::SqlitePool;
use twitch_api::twitch_oauth2::TwitchToken;
use twitch_api::twitch_oauth2::UserToken;
use twitch_api::HelixClient;
use twitch_irc::message::PrivmsgMessage;
use twitch_irc::message::ServerMessage;
use twitch_types::UserId;

use crate::apis::twitch;
use crate::handlers::persistence::Handler;

pub struct RipBozo<'a> {
    pub broadcaster_id: UserId,
    pub token: UserToken,
    pub helix_client: HelixClient<'a, reqwest::Client>,
    pub db_pool: SqlitePool,
}

impl<'a> RipBozo<'a> {
    pub fn handler(&self) -> Handler {
        Handler::RipBozo
    }
}

impl<'a> RipBozo<'a> {
    pub async fn handle(&mut self, server_message: &ServerMessage) {
        if let ServerMessage::Privmsg(message @ PrivmsgMessage { is_action: false, .. }) = server_message {
            if message
                .badges
                .iter()
                .any(|b| b.name == "moderator" || b.name == "broadcaster")
            {
                return;
            }

            if should_delete(&message.message_text) {
                self.delete_message_with_token_refresh(message, server_message).await;
            }
        }
    }

    #[async_recursion]
    async fn delete_message_with_token_refresh(&mut self, message: &PrivmsgMessage, server_message: &ServerMessage) {
        match self
            .helix_client
            .delete_chat_message(
                &self.broadcaster_id,
                &self.token.user_id,
                &message.message_id,
                &self.token,
            )
            .await
        {
            Ok(delete_response) => println!(
                "Message deleted {:?}, delete response {:?}",
                server_message, delete_response
            ),
            Err(error) => {
                eprintln!("Error deleting message {:?}, error {:?}", server_message, error);

                if twitch::helpers::is_unauthorized_error(&error) {
                    eprintln!("Refreshing token");
                    self.token.refresh_token(self.helix_client.get_client()).await.unwrap();
                    self.delete_message_with_token_refresh(message, server_message).await
                }
            }
        }
    }
}

lazy_static! {
    static ref ANY_EMOJI_REGEX: Regex = Regex::new(r#"\p{Emoji}"#).unwrap();
}

fn should_delete(message_text: &str) -> bool {
    if ANY_EMOJI_REGEX.is_match(message_text) {
        return false;
    }

    let no_whitespaces = message_text.chars().filter(|c| !c.is_whitespace());
    let (ascii, not_ascii): (Vec<char>, Vec<char>) = no_whitespaces.clone().partition(char::is_ascii);

    let not_ascii_count = not_ascii.len();
    if not_ascii_count == 0 {
        return false;
    }

    if not_ascii.iter().all(|x| x == &'тАж') {
        return false;
    }

    let ascii_count = ascii.len();
    let not_ascii_perc = (not_ascii_count as f64 / (not_ascii_count + ascii_count) as f64) * 100.0;

    not_ascii_perc >= 45.0
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_should_delete() {
        assert!(!should_delete(r#""#));
        assert!(!should_delete(r#" "#));
        assert!(!should_delete(r#"ciao"#));
        assert!(!should_delete(r#"..."#));
        assert!(!should_delete(r#"......"#));
        assert!(!should_delete(r#"........."#));
        assert!(!should_delete(r#"тАж"#));
        assert!(!should_delete(r#"тАжo"#));
        assert!(should_delete(r#"тАж├╢"#));
        assert!(!should_delete(
            r#""El presidente del Congreso, que a├║n no ha manifestado si se adherir├б o no a la iniciativa del ministro de Industria, no quiso dar trascendencia al asunto, ┬лque no tiene m├бs valor que el de una an├йcdota y el de una corbata regalada┬╗."#
        ));
        assert!(!should_delete(
            r#"
                тЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕ
                тЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕ
                тЬЕтЬЕтмЫтмЫтмЫтЬЕтЬЕтмЫтмЫтмЫтЬЕтЬЕ
                тЬЕтЬЕтмЫтмЫтмЫтЬЕтЬЕтмЫтмЫтмЫтЬЕтЬЕ
                тЬЕтЬЕтЬЕтЬЕтЬЕтмЫтмЫтЬЕтЬЕтЬЕтЬЕтЬЕ
                тЬЕтЬЕтЬЕтмЫтмЫтмЫтмЫтмЫтмЫтЬЕтЬЕтЬЕ
                тЬЕтЬЕтЬЕтмЫтмЫтмЫтмЫтмЫтмЫтЬЕтЬЕтЬЕ
                тЬЕтЬЕтЬЕтмЫтмЫтЬЕтЬЕтмЫтмЫтЬЕтЬЕтЬЕ
                тЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕтЬЕ
            "#
        ));
        assert!(!should_delete(r#"ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓"#));
        assert!(!should_delete(
            r#"ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓"#
        ));

        assert!(!should_delete(
            r#"ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓ЁЯе▓"#
        ));
        assert!(!should_delete(
            r#"ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓ ЁЯе▓"#
        ));
        assert!(!should_delete(
            r#"
                YOUтАЩVE BEEN FREAKING HIT BY THE

                |^^^^^^^^^^^^](я╛ЙтЧХуГотЧХ)я╛Й*:я╜ея╛ЯтЬз
                | KAWAII TRUCK | тАШ|тАЭтАЬтАЭ;.., ___.
                |_тАж_тАж______===|= _|__|тАж, ] |
                тАЭ(@ )тАЩ(@ )тАЭтАЬтАЭтАЬ*|(@ )(@ )*****(@уААуААуААуААтКВя╝Ия╛Я╨Фя╛ЯтКВтМТя╝Й NO KAWAII TRUCK NO!!!

                RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM RANDOM.
            "#
        ));
        assert!(should_delete(
            r#"
                тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐та┐таЛтаЙтаЙтаЙтаДтаИтаЙтаЩта┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐
                тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐таЯтаЛтаБтаДтаДтаДтгАтгдтг┤тг╢тгдтгдтгАтаИтв┐тг┐тг┐тг┐тг┐тг┐
                тг┐тг┐тг┐тг┐тг┐тг┐тб┐таЛтаБтаДтаДтаДтаДтв╕тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг╖тбДтв╗тг┐тг┐тг┐тг┐
                тг┐тг┐тг┐тг┐тг┐тбЯтаБтаДтаДтаДтаДтаДтаЙтгЫтгЫтгЫтбЫтв╗тг┐тг┐тг┐тг┐тг┐тг┐тбАтв╗тг┐тг┐тг┐
                тг┐тг┐тг┐тб┐таЛтаДтаДтаДтаДтаДтаДтг╛тг┐тбЯтв▒тгЖтаДта┐тв┐тг┐тг┐тгптамтгЩтбЗтаШтг┐тг┐тг┐
                тг┐тг┐тг┐тбЗтаДтаДтаДтаДтаДтаДтаДтг╗тг┐тг┐тгнтг╡тгжтаДтгатг┐тбИтв┐тгАтг╕тбЗтаДтг┐тг┐тг┐
                тг┐тг┐тг┐тгЗтаДтаДтаДтаДтаДтаДтв░тг┐тг┐тг┐тг┐тг┐тб┐таГтвитаЯтг╖тг┐тг┐тг┐таГтаДтв┐тг┐тг┐
                тг┐тг┐тг┐тг┐таДтаДтаДтаДтаДтаДта╕тг┐тг┐тг┐таЯтаБтаДтаДтаДтаДта╣тг┐тг┐тг┐таДтаДтаДтг┐тг┐
                тг┐тг┐тг┐тг┐тбДтаДтаДтаДтаДтаДтаДтгатг┐тг┐тб┐твВтгАтв╕тгжтаДтаДтг╣тг┐таЗтаДтаДтг╝тг┐тг┐
                тг┐тг┐тг┐тг┐тг┐тгзтаДтаДтвАтг┤тг┐тг┐тгЯтгЙтг┤тг┐таЗтгатг╛таВтаДтаИтаДтаДтвАтг╝тг┐тг┐тг┐
                тг┐тг┐тг┐тг┐тб┐таЯтвАтг┤тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг╡тг┐тб┐тггтаДтаДтаДтаДтг░тг┐тг┐та┐таЛтаЙ
                таЫтаЛтаЙтаБтаДтгатг╛тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг╡тб┐таГтаДтаДтаДтватг┐таЯтаБтаДтаДтаД
                таДтаДтаДтаДтг╝тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тб┐таЛтаДтаДтаДтаДтаДтаИтаБтаДтаДтаДтаДтаД
                таДтаДтвАтг░тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тб┐таЛтаДтаДтаДтаДтаДтаДтаДтаДтаДтаДтаДтаДтаДтаД
            "#
        ));
        assert!(should_delete(
            r#"тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐та┐таЛтаЙтаЙтаЙтаДтаИтаЙтаЩта┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐ тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐таЯтаЛтаБтаДтаДтаДтгАтгдтг┤тг╢тгдтгдтгАтаИтв┐тг┐тг┐тг┐тг┐тг┐ тг┐тг┐тг┐тг┐тг┐тг┐тб┐таЛтаБтаДтаДтаДтаДтв╕тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг╖тбДтв╗тг┐тг┐тг┐тг┐ тг┐тг┐тг┐тг┐тг┐тбЯтаБтаДтаДтаДтаДтаДтаЙтгЫтгЫтгЫтбЫтв╗тг┐тг┐тг┐тг┐тг┐тг┐тбАтв╗тг┐тг┐тг┐ тг┐тг┐тг┐тб┐таЛтаДтаДтаДтаДтаДтаДтг╛тг┐тбЯтв▒тгЖтаДта┐тв┐тг┐тг┐тгптамтгЩтбЗтаШтг┐тг┐тг┐ тг┐тг┐тг┐тбЗтаДтаДтаДтаДтаДтаДтаДтг╗тг┐тг┐тгнтг╡тгжтаДтгатг┐тбИтв┐тгАтг╕тбЗтаДтг┐тг┐тг┐ тг┐тг┐тг┐тгЗтаДтаДтаДтаДтаДтаДтв░тг┐тг┐тг┐тг┐тг┐тб┐таГтвитаЯтг╖тг┐тг┐тг┐таГтаДтв┐тг┐тг┐ тг┐тг┐тг┐тг┐таДтаДтаДтаДтаДтаДта╕тг┐тг┐тг┐таЯтаБтаДтаДтаДтаДта╣тг┐тг┐тг┐таДтаДтаДтг┐тг┐ тг┐тг┐тг┐тг┐тбДтаДтаДтаДтаДтаДтаДтгатг┐тг┐тб┐твВтгАтв╕тгжтаДтаДтг╣тг┐таЗтаДтаДтг╝тг┐тг┐ тг┐тг┐тг┐тг┐тг┐тгзтаДтаДтвАтг┤тг┐тг┐тгЯтгЙтг┤тг┐таЗтгатг╛таВтаДтаИтаДтаДтвАтг╝тг┐тг┐тг┐ тг┐тг┐тг┐тг┐тб┐таЯтвАтг┤тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг╡тг┐тб┐тггтаДтаДтаДтаДтг░тг┐тг┐та┐таЛтаЙ таЫтаЛтаЙтаБтаДтгатг╛тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг╡тб┐таГтаДтаДтаДтватг┐таЯтаБтаДтаДтаД таДтаДтаДтаДтг╝тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тб┐таЛтаДтаДтаДтаДтаДтаИтаБтаДтаДтаДтаДтаД таДтаДтвАтг░тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тб┐таЛтаДтаДтаДтаДтаДтаДтаДтаДтаДтаДтаДтаДтаДтаД "#
        ));
        assert!(should_delete(
            r#"тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐та┐таЛтаЙтаЙтаЙтаДтаИтаЙтаЩта┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐таЯтаЛтаБтаДтаДтаДтгАтгдтг┤тг╢тгдтгдтгАтаИтв┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тб┐таЛтаБтаДтаДтаДтаДтв╕тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг╖тбДтв╗тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тбЯтаБтаДтаДтаДтаДтаДтаЙтгЫтгЫтгЫтбЫтв╗тг┐тг┐тг┐тг┐тг┐тг┐тбАтв╗тг┐тг┐тг┐тг┐тг┐тг┐тб┐таЛтаДтаДтаДтаДтаДтаДтг╛тг┐тбЯтв▒тгЖтаДта┐тв┐тг┐тг┐тгптамтгЩтбЗтаШтг┐тг┐тг┐тг┐тг┐тг┐тбЗтаДтаДтаДтаДтаДтаДтаДтг╗тг┐тг┐тгнтг╡тгжтаДтгатг┐тбИтв┐тгАтг╕тбЗтаДтг┐тг┐тг┐тг┐тг┐тг┐тгЗтаДтаДтаДтаДтаДтаДтв░тг┐тг┐тг┐тг┐тг┐тб┐таГтвитаЯтг╖тг┐тг┐тг┐таГтаДтв┐тг┐тг┐тг┐тг┐тг┐тг┐таДтаДтаДтаДтаДтаДта╕тг┐тг┐тг┐таЯтаБтаДтаДтаДтаДта╣тг┐тг┐тг┐таДтаДтаДтг┐тг┐тг┐тг┐тг┐тг┐тбДтаДтаДтаДтаДтаДтаДтгатг┐тг┐тб┐твВтгАтв╕тгжтаДтаДтг╣тг┐таЗтаДтаДтг╝тг┐тг┐тг┐тг┐тг┐тг┐тг┐тгзтаДтаДтвАтг┤тг┐тг┐тгЯтгЙтг┤тг┐таЗтгатг╛таВтаДтаИтаДтаДтвАтг╝тг┐тг┐тг┐тг┐тг┐тг┐тг┐тб┐таЯтвАтг┤тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг╡тг┐тб┐тггтаДтаДтаДтаДтг░тг┐тг┐та┐таЛтаЙтаЫтаЛтаЙтаБтаДтгатг╛тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг╡тб┐таГтаДтаДтаДтватг┐таЯтаБтаДтаДтаДтаДтаДтаДтаДтг╝тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тб┐таЛтаДтаДтаДтаДтаДтаИтаБтаДтаДтаДтаДтаДтаДтаДтвАтг░тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тг┐тб┐таЛтаДтаДтаДтаДтаДтаДтаДтаДтаДтаДтаДтаДтаДтаД"#
        ));
        assert!(should_delete(
            r#"тЦСтЦСтЦСтЦСтЦИтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтЦИтФАтФАтЦАтФАтФА тЦСтЦСтЦСтЦСтЦУтЦИтФАтФАтФАтФАтФАтФАтФАтЦДтЦДтЦАтЦАтЦИтФАтФАтФАтФАтФАтФА тЦСтЦСтЦСтЦСтЦТтЦСтЦИтФАтФАтФАтФАтЦДтЦИтЦТтЦСтЦСтЦДтЦСтЦИтФАтФАтФАтФАтФА тЦСтЦСтЦСтЦСтЦСтЦСтЦСтЦАтЦДтФАтЦДтЦАтЦТтЦАтЦАтЦАтЦДтЦДтЦАтФАтФАDOтФА тЦСтЦСтЦСтЦСтЦСтЦСтЦСтЦСтЦСтЦИтЦТтЦСтЦСтЦСтЦСтЦДтЦАтФАтФАтФАYOUтФА тЦТтЦТтЦТтЦСтЦСтЦСтЦСтЦДтЦАтЦТтЦСтЦСтЦСтЦСтЦДтЦАтФАтФАтФАLIKEтФА тЦУтЦУтЦУтЦУтЦТтЦСтЦИтЦТтЦСтЦСтЦСтЦСтЦСтЦИтЦДтФАтФАтФАWHATтФА тЦИтЦИтЦИтЦИтЦИтЦАтЦТтЦСтЦСтЦСтЦСтЦСтЦИтЦСтЦАтЦДтФАтФАтФАYOUтФАтФА тЦИтЦИтЦИтЦИтЦИтЦТтЦТтЦСтЦСтЦСтЦТтЦИтЦСтЦСтЦСтЦАтЦДтФАSEE?тФАтФА тЦИтЦИтЦИтЦУтЦУтЦТтЦТтЦТтЦАтЦАтЦАтЦИтЦДтЦСтЦСтЦСтЦСтЦИтФАтФАтФАтФАтФАтФА тЦУтЦИтЦИтЦУтЦТтЦТтЦТтЦТтЦТтЦТтЦТтЦТтЦТтЦИтЦСтЦСтЦСтЦСтЦИтФАтФАтФАтФАтФА тЦУтЦУтЦИтЦУтЦТтЦТтЦТтЦТтЦТтЦТтЦУтЦТтЦТтЦИтЦСтЦСтЦСтЦСтЦСтЦИтФАтФАтФАтФА тЦСтЦТтЦТтЦАтЦАтЦДтЦДтЦДтЦДтЦИтЦДтЦДтЦАтЦСтЦСтЦСтЦСтЦСтЦСтЦСтЦИтФА "#
        ));
        assert!(should_delete(
            r#"
                тАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФNo stiches?тАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФ
                таАтгЮтв╜твктвгтвгтвгтвлтб║тб╡тгЭтботгЧтв╖тв╜тв╜тв╜тготб╖тб╜тгЬтгЬтвотв║тгЬтв╖тв╜твЭтб╜тгЭ
                та╕тб╕таЬтаХтаХтаБтвБтвЗтвПтв╜тв║тгктб│тбЭтгОтгПтвптвЮтб┐тгЯтг╖тг│твптб╖тг╜тв╜твптг│тглтаЗ
                таАтаАтвАтвАтвДтвмтвктбктбОтгЖтбИтаЪтаЬтаХтаЗтаЧтаЭтвХтвптвлтгЮтгптг┐тг╗тб╜тгПтвЧтгЧтаПтаА
                таАтактбктбктгктвктв║тв╕тввтвУтвЖтвдтвАтаАтаАтаАтаАтаИтвКтвЮтб╛тг┐тбптгПтвота╖таБтаАтаА
                таАтаАтаАтаИтаКтаЖтбГтаХтвХтвЗтвЗтвЗтвЗтвЗтвПтвОтвОтвЖтвДтаАтвСтг╜тг┐твЭта▓таЙтаАтаАтаАтаА
                таАтаАтаАтаАтаАтб┐таВтаатаАтбЗтвЗтаХтвИтгАтаАтаБтабтагтбгтблтгВтг┐таптвкта░таВтаАтаАтаАтаА
                таАтаАтаАтаАтбжтбЩтбВтвАтвдтвгтагтбИтг╛тбГтаатаДтаАтбДтв▒тгМтг╢твПтвКтаВтаАтаАтаАтаАтаАтаА
                таАтаАтаАтаАтвЭтб▓тгЬтботбПтвОтвМтвВтаЩтавтаРтвАтвШтв╡тг╜тг┐тб┐таБтаБтаАтаАтаАтаАтаАтаАтаА
                таАтаАтаАтаАтаитг║тб║тбХтбХтб▒тбСтбЖтбХтбЕтбХтбЬтб╝тв╜тб╗таПтаАтаАтаАтаАтаАтаАтаАтаАтаАтаА
                таАтаАтаАтаАтг╝тг│тглтг╛тг╡тгЧтб╡тб▒тббтвгтвСтвХтвЬтвХтбЭтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаА
                таАтаАтаАтг┤тг┐тг╛тг┐тг┐тг┐тб┐тб╜тбСтвМтактбвтбгтггтбЯтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаА
                таАтаАтаАтбЯтб╛тг┐тв┐тв┐тв╡тг╜тг╛тг╝тгШтв╕тв╕тгЮтбЯтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаА
                таАтаАтаАтаАтаБтаЗтабтайтблтв┐тгЭтб╗тботгТтв╜таЛтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаАтаА
                тАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФ-
            "#
        ));
        assert!(should_delete(
            r#"
                |я┐гя┐гя┐гя┐гя┐гя┐гя┐гя┐гя┐гя┐гя┐г|
                        insert
                        text
                        here
                |я╝┐я╝┐я╝┐я╝┐я╝┐я╝┐я╝┐я╝┐я╝┐я╝┐я╝┐|
                    \ (тАвтЧбтАв) /
                        \      /
                        ---
                        |   |
            "#
        ));
        assert!(should_delete(
            r#"
                |я┐гя┐гя┐гя┐гя┐гя┐гя┐гя┐гя┐гя┐гя┐г|
                        hola
                |я╝┐я╝┐я╝┐я╝┐я╝┐я╝┐я╝┐я╝┐я╝┐я╝┐я╝┐|
                    \ (тАвтЧбтАв) /
                        \      /
                        ---
                        |   |
            "#
        ));
    }
}
